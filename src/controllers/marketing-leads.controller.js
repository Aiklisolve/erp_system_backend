import { query } from '../config/database.js';

const LEADS_TABLE = 'marketing_leads';
const CAMPAIGNS_TABLE = 'marketing_campaigns';

// Helper function to format lead response
function formatLeadResponse(lead) {
  return {
    id: lead.id?.toString(),
    lead_code: lead.lead_code || null,
    campaign_id: lead.campaign_id?.toString() || null,
    campaign_name: lead.campaign_name || null,
    source: lead.source || null,
    first_name: lead.first_name || null,
    last_name: lead.last_name || null,
    email: lead.email || null,
    phone: lead.phone || null,
    company: lead.company || null,
    job_title: lead.job_title || null,
    status: lead.status || 'NEW',
    score: lead.score !== null && lead.score !== undefined ? lead.score : 0,
    notes: lead.notes || null,
    created_at: lead.created_at,
    updated_at: lead.updated_at
  };
}

// List all leads with optional campaign_id filter
export async function listLeads(req, res, next) {
  try {
    const { campaign_id } = req.query;

    let sql = `SELECT * FROM ${LEADS_TABLE}`;
    const params = [];
    let paramIndex = 1;

    if (campaign_id) {
      sql += ` WHERE campaign_id = $${paramIndex}`;
      params.push(campaign_id);
      paramIndex++;
    }

    sql += ` ORDER BY created_at DESC`;

    const result = await query(sql, params);

    const leads = result.rows.map(formatLeadResponse);

    return res.json({
      success: true,
      data: leads,
      count: leads.length
    });
  } catch (err) {
    console.error('Error listing leads:', err);
    return res.status(500).json({
      success: false,
      message: 'Internal server error',
      error_code: err.code || 'DATABASE_ERROR',
      timestamp: new Date().toISOString()
    });
  }
}

// Get single lead by ID
export async function getLeadById(req, res, next) {
  try {
    const { id } = req.params;

    const result = await query(
      `SELECT * FROM ${LEADS_TABLE} WHERE id = $1`,
      [id]
    );

    if (result.rowCount === 0) {
      return res.status(404).json({
        success: false,
        message: 'Lead not found',
        error_code: 'LEAD_NOT_FOUND',
        timestamp: new Date().toISOString()
      });
    }

    const lead = formatLeadResponse(result.rows[0]);

    return res.json({
      success: true,
      data: lead
    });
  } catch (err) {
    console.error('Error getting lead:', err);
    return res.status(500).json({
      success: false,
      message: 'Internal server error',
      error_code: err.code || 'DATABASE_ERROR',
      timestamp: new Date().toISOString()
    });
  }
}

// Create new lead
export async function createLead(req, res, next) {
  try {
    const {
      campaign_id,
      campaign_name,
      source,
      first_name,
      last_name,
      email,
      phone,
      company,
      job_title,
      status = 'NEW',
      score = 0,
      notes,
      lead_code // Optional, will be auto-generated by database trigger if not provided
    } = req.body;

    // Validate score range
    if (score !== null && score !== undefined) {
      if (typeof score !== 'number' || score < 0 || score > 100) {
        return res.status(400).json({
          success: false,
          message: 'Validation error',
          errors: {
            score: 'Score must be between 0 and 100'
          },
          timestamp: new Date().toISOString()
        });
      }
    }

    // Validate email format if provided
    if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      return res.status(400).json({
        success: false,
        message: 'Validation error',
        errors: {
          email: 'Invalid email format'
        },
        timestamp: new Date().toISOString()
      });
    }

    // Auto-populate campaign_name from campaign_id if not provided
    let finalCampaignName = campaign_name;
    if (campaign_id && !campaign_name) {
      try {
        const campaignResult = await query(
          `SELECT name FROM ${CAMPAIGNS_TABLE} WHERE id = $1`,
          [campaign_id]
        );
        if (campaignResult.rowCount > 0) {
          finalCampaignName = campaignResult.rows[0].name;
        }
      } catch (campaignErr) {
        // Log but don't fail - campaign_name is optional
        console.warn('Could not fetch campaign name:', campaignErr);
      }
    }

    // Insert lead (lead_code will be auto-generated by database trigger if not provided)
    const result = await query(
      `
      INSERT INTO ${LEADS_TABLE} (
        lead_code, campaign_id, campaign_name, source,
        first_name, last_name, email, phone,
        company, job_title, status, score, notes,
        created_at, updated_at
      )
      VALUES (
        $1, $2, $3, $4,
        $5, $6, $7, $8,
        $9, $10, $11, $12, $13,
        NOW(), NOW()
      )
      RETURNING *
      `,
      [
        lead_code || null, // Let database trigger generate if null
        campaign_id || null,
        finalCampaignName || null,
        source || null,
        first_name || null,
        last_name || null,
        email || null,
        phone || null,
        company || null,
        job_title || null,
        status,
        score,
        notes || null
      ]
    );

    const lead = formatLeadResponse(result.rows[0]);

    return res.status(201).json({
      success: true,
      data: lead
    });
  } catch (err) {
    if (err.code === '23505') {
      // Unique constraint violation (lead_code)
      return res.status(400).json({
        success: false,
        message: 'Validation error',
        errors: {
          lead_code: 'Lead code already exists'
        },
        timestamp: new Date().toISOString()
      });
    }
    if (err.code === '23503') {
      // Foreign key constraint violation
      return res.status(400).json({
        success: false,
        message: 'Validation error',
        errors: {
          campaign_id: 'Invalid campaign_id reference'
        },
        timestamp: new Date().toISOString()
      });
    }
    console.error('Error creating lead:', err);
    return res.status(500).json({
      success: false,
      message: 'Internal server error',
      error_code: err.code || 'DATABASE_ERROR',
      timestamp: new Date().toISOString()
    });
  }
}

// Update existing lead
export async function updateLead(req, res, next) {
  try {
    const { id } = req.params;
    const {
      campaign_id,
      campaign_name,
      source,
      first_name,
      last_name,
      email,
      phone,
      company,
      job_title,
      status,
      score,
      notes
    } = req.body;

    // Validate score range if provided
    if (score !== null && score !== undefined) {
      if (typeof score !== 'number' || score < 0 || score > 100) {
        return res.status(400).json({
          success: false,
          message: 'Validation error',
          errors: {
            score: 'Score must be between 0 and 100'
          },
          timestamp: new Date().toISOString()
        });
      }
    }

    // Validate email format if provided
    if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      return res.status(400).json({
        success: false,
        message: 'Validation error',
        errors: {
          email: 'Invalid email format'
        },
        timestamp: new Date().toISOString()
      });
    }

    // Build dynamic update query
    const updates = [];
    const params = [];
    let paramIndex = 1;

    if (campaign_id !== undefined) {
      updates.push(`campaign_id = $${paramIndex++}`);
      params.push(campaign_id || null);
    }
    if (campaign_name !== undefined) {
      updates.push(`campaign_name = $${paramIndex++}`);
      params.push(campaign_name || null);
    }
    if (source !== undefined) {
      updates.push(`source = $${paramIndex++}`);
      params.push(source || null);
    }
    if (first_name !== undefined) {
      updates.push(`first_name = $${paramIndex++}`);
      params.push(first_name || null);
    }
    if (last_name !== undefined) {
      updates.push(`last_name = $${paramIndex++}`);
      params.push(last_name || null);
    }
    if (email !== undefined) {
      updates.push(`email = $${paramIndex++}`);
      params.push(email || null);
    }
    if (phone !== undefined) {
      updates.push(`phone = $${paramIndex++}`);
      params.push(phone || null);
    }
    if (company !== undefined) {
      updates.push(`company = $${paramIndex++}`);
      params.push(company || null);
    }
    if (job_title !== undefined) {
      updates.push(`job_title = $${paramIndex++}`);
      params.push(job_title || null);
    }
    if (status !== undefined) {
      updates.push(`status = $${paramIndex++}`);
      params.push(status);
    }
    if (score !== undefined) {
      updates.push(`score = $${paramIndex++}`);
      params.push(score);
    }
    if (notes !== undefined) {
      updates.push(`notes = $${paramIndex++}`);
      params.push(notes || null);
    }

    // Auto-populate campaign_name from campaign_id if campaign_id is updated but campaign_name is not
    if (campaign_id !== undefined && campaign_name === undefined && campaign_id) {
      try {
        const campaignResult = await query(
          `SELECT name FROM ${CAMPAIGNS_TABLE} WHERE id = $1`,
          [campaign_id]
        );
        if (campaignResult.rowCount > 0) {
          updates.push(`campaign_name = $${paramIndex++}`);
          params.push(campaignResult.rows[0].name);
        }
      } catch (campaignErr) {
        // Log but don't fail - campaign_name is optional
        console.warn('Could not fetch campaign name:', campaignErr);
      }
    }

    if (updates.length === 0) {
      // No fields to update, return current lead
      const currentResult = await query(
        `SELECT * FROM ${LEADS_TABLE} WHERE id = $1`,
        [id]
      );
      if (currentResult.rowCount === 0) {
        return res.status(404).json({
          success: false,
          message: 'Lead not found',
          error_code: 'LEAD_NOT_FOUND',
          timestamp: new Date().toISOString()
        });
      }
      return res.json({
        success: true,
        data: formatLeadResponse(currentResult.rows[0])
      });
    }

    updates.push(`updated_at = NOW()`);
    params.push(id);

    const result = await query(
      `
      UPDATE ${LEADS_TABLE}
      SET ${updates.join(', ')}
      WHERE id = $${paramIndex}
      RETURNING *
      `,
      params
    );

    if (result.rowCount === 0) {
      return res.status(404).json({
        success: false,
        message: 'Lead not found',
        error_code: 'LEAD_NOT_FOUND',
        timestamp: new Date().toISOString()
      });
    }

    const lead = formatLeadResponse(result.rows[0]);

    return res.json({
      success: true,
      data: lead
    });
  } catch (err) {
    if (err.code === '23503') {
      // Foreign key constraint violation
      return res.status(400).json({
        success: false,
        message: 'Validation error',
        errors: {
          campaign_id: 'Invalid campaign_id reference'
        },
        timestamp: new Date().toISOString()
      });
    }
    console.error('Error updating lead:', err);
    return res.status(500).json({
      success: false,
      message: 'Internal server error',
      error_code: err.code || 'DATABASE_ERROR',
      timestamp: new Date().toISOString()
    });
  }
}

// Delete lead
export async function deleteLead(req, res, next) {
  try {
    const { id } = req.params;

    const result = await query(
      `DELETE FROM ${LEADS_TABLE} WHERE id = $1 RETURNING id`,
      [id]
    );

    if (result.rowCount === 0) {
      return res.status(404).json({
        success: false,
        message: 'Lead not found',
        error_code: 'LEAD_NOT_FOUND',
        timestamp: new Date().toISOString()
      });
    }

    return res.json({
      success: true,
      message: 'Lead deleted successfully'
    });
  } catch (err) {
    console.error('Error deleting lead:', err);
    return res.status(500).json({
      success: false,
      message: 'Internal server error',
      error_code: err.code || 'DATABASE_ERROR',
      timestamp: new Date().toISOString()
    });
  }
}

